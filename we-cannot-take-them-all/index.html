<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>
</head>

<body>

  <button type="button" style="font-size:12; visibility:hidden" id="startRecogniser" onclick="startRecogniser()">Listen to me</button><br>

  <!--<p color="gray" class="pulse"> ... listening</div>-->

  <div id="recognitionDiv" style="border:1px dotted black; border-radius:8px; visibility:visible">
    <p id="recognitionP" style="visibility:visible" color="gray" class="pulse"> ... </p>
  </div>
  <div id="synthSpeakingDiv">
  </div>

  <p id="p2"> </p>

  <button type="button" style="font-size:10vw" id="activationButton" onclick="activate()">Make sure your sound is on. Then click me to begin.</button><br>

  <div id="instructionsDiv">
  </div>
  <div id="refugeeSituationDiv">
  </div>

  <p id="p3"> </p>

  <script>

  //We Cannot Take Them All
  //or: The Others

  //This text is a very slightly modified version of what appears in:
  //Carens, Joseph (2015) The Ethics of Immigration. London: Oxford University Press.
  //This excerpt is an imaginary list of reasons for why the general public
  //in America may have been opposed to the idea of admitting Jewish refugees
  //during World War Two. The idea is that these types of rationalisations
  //may have surfaced during public discourse at the time, even by people who
  //considered themselves only mildly opposed to the idea of admitting
  //refugees.

  //Carens' purpose with presenting these generalisations is to call our
  //attention to how, in the light of what was revealed in the aftermath of the
  //war of the full extent of the unacceptable and deadly conditions and
  //discrimination to which Jews were subject under the Nazi regime,
  //the concerns raised in these statements become blatantly disproportionate
  //and meaningless to the extent of the suffering and true peril which the
  //people fleeing Nazi persecution were facing at their origin countries.

  //Carens presents us with these statements so that we may reflect on the one
  //hand, on whether we can identify this very same type of reasoning emerging
  //in public discourse related to contemporary "refugee situations", and
  //furthermore, to play out the thought experiment of: what if we later come
  //to understand a more full picture of the suffering of the people who have
  //chosen to distance themselves physically from the situations that produced
  //their misery? Will these arguments continue to hold even the slightest
  //degree of reason or moral weight, all other aspects considered?

  //The purpose of translating Carens' text into a generative piece which
  //relies heavily on speech interaction is twofold: On the one hand, we utilise
  //synthetic speech to invoke the idea of various countries and nationalities:
  //whether familiar to us or not, a foreign accent will invoke a sense of another
  //country. Meanwhile, it is also humorous to be exposed to a synthetic voice
  //speaking in a heavy accent, which in turn makes one more likely to engage
  //further with the piece. Moreover, the user cannot simply click to interact,
  //but must use their very voice to tell the system "I am from __country__".
  //Most will begin by choosing their own country, as this is the most natural
  //statement to make. However, in order to further engage with the piece,
  //one will begin to say "I am from __another country__ " in order to hear
  //what that accent sounds like. One will choose accents with which one is
  //familiar, or perhaps "play through them all" just for the fun of it.

  //Meanwhile, amidst this play, the user inevitably is exposed to a mantra,
  //which always begins with these three sentences:
  //What is happening to the others is too bad, but it's not our fault. We
  //cannot take them all. We have our own problems.

  //Through the humour of the very human factor of linguistic accents in
  //spoken english, and through the fun of seeing their own speech transcribed
  //onto the screen, the user is transported into the midst of the multifaceted
  //discourse on whether or not societies should grant refuge to fellow humans
  //in need.

  var carensGeneralisation = [
    "What is happening to the Jews is too bad, but it's not our fault. We cannot take them all. " +
    "We have our own problems. ",
    "If we take in all the Jews who want to come, we will be overwhelmed. " +
    "There are simply too many of them. ",
    "Besides, while Jews may be subject to discrimination and occasional acts of violence, things are not as bad as their advocacy groups say. " +
    "They exaggerate the problem. ",
    "Many of the Jews just want better economic opportunities than they have at home. " +
    "The ones who manage to make it to North America cannot be among the worst off because they have enough economic resources to cross the Atlantic. ",
    "Times are tough here. " +
    "We have an obligation to look out for our own needy first. ",
    "A large infux of Jews could be a cultural and political threat. " +
    "They don't share our religious traditions or our democratic values. ",
    "Some of them are communists and pose a basic security threat, but it's hard to be sure which ones, so it's better not to let any of them in. ",
    "Many of them have shown that they don't respect the law because they have purchased forged documents, hired smugglers to transport them illegally, and lied to our immigration officials. ",
    "Admitting Jewish refugees does not help to address the underlying problems that have given rise to the Nazi phenomenon."
  ]; // (Carens 2015, 193).

    var languages = [
      {bcp: "ar-SA", language: "Arabic", country: "Saudi Arabia"},
      {bcp: "cs-CZ", language: "Czech", country: "the Czech Republic"},
      {bcp: "da-DK", language: "Danish", country: "Denmark"},
      {bcp: "de-DE", language: "German", country: "Germany"},
      {bcp: "el-GR", language: "Modern Greek", country: "Greece"},
      {bcp: "en-AU", language: "English", country: "Australia"},
      {bcp: "en-GB", language: "English", country: "Great Britain"},
      {bcp: "en-IE", language: "English", country: "Ireland"},
      {bcp: "en-US", language: "English", country: "America"},
      {bcp: "en-ZA", language: "English", country: "South Africa"},
      {bcp: "es-ES", language: "Spanish", country: "Spain"},
      {bcp: "es-MX", language: "Spanish", country: "Mexico"},
      {bcp: "fi-FI", language: "Finnish", country: "Finland"},
      {bcp: "fr-CA", language: "French", country: "Canada"},
      {bcp: "fr-FR", language: "French", country: "France"},
      {bcp: "he-IL", language: "Hebrew", country: "Israel"},
      {bcp: "hi-IN", language: "Hindi", country: "India"},
      {bcp: "hu-HU", language: "Hungarian", country: "Hungary"},
      {bcp: "id-ID", language: "Indonesian", country: "Indonesia"},
      {bcp: "it-IT", language: "Italian", country: "Italy"},
      {bcp: "ja-JP", language: "Japanese", country: "Japan"},
      {bcp: "ko-KR", language: "Korean", country: "South Korea"},
      {bcp: "nl-BE", language: "Dutch", country: "Belgium"},
      {bcp: "nl-NL", language: "Dutch", country: "the Netherlands"},
      {bcp: "no-NO", language: "Norwegian", country: "Norway"},
      {bcp: "pl-PL", language: "Polish", country: "Poland"},
      {bcp: "pt-BR", language: "Portuguese", country: "Brazil"},
      {bcp: "pt-PT", language: "Portuguese", country: "Portugal"},
      {bcp: "ro-RO", language: "Romanian", country: "Romania"},
      {bcp: "ru-RU", language: "Russian", country: "Russia"},
      {bcp: "sk-SK", language: "Slovak", country: "Slovakia"},
      {bcp: "sv-SE", language: "Swedish", country: "Sweden"},
      {bcp: "th-TH", language: "Thai", country: "Thailand"},
      {bcp: "tr-TR", language: "Turkish", country: "Turkey"},
      {bcp: "zh-CN", language: "Chinese", country: "China"},
      {bcp: "zh-HK", language: "Chinese", country: "Hong Kong"},
      {bcp: "zh-TW", language: "Chinese", country: "Taiwan"}
    ];

    var languagesArray = [];

    var information = "Let's listen to why we cannot take them all. " +
    "Now, choose a nationality by saying, for example, 'I am from America':";

    //for testing purposes:
    //var information = "Let's listen";

    //create a single refugee situtation object,
    //with any number of concepts, words and phrases for any of the fields
    //Let the algorithm choose from these and mix and match.
    //And try to keep the structure of this data the same:

    // ME is described through two simple parameters:
    // 1) the words and concepts that I use to describe The Other,
    // and
    // 2) what it is that makes me scared about them.

    // The way that the refugee is described hinges on three important elements:
    // 1) what it is that they are physically distancing themselves from,
    // 2) the barriers,
    // physical as well as invisible,
    // that they face as they attempt to project themselves
    // away from their source of misery and towards their safe haven,
    // and
    // 3) the way we describe what they perceive as safety/a safe place.

    //Although the original text is by Joseph Carens, the creation of these
    //alternate, poetic, abstract and imaginative ways to generalise these five
    //aspects describing refugees and "Me" in any refugee situation, can be
    //understood as the creative and literary authorship of me.

    //Also, and importantly: the original idea of thinking through these
    //hypothetical reasonings and generalisations related to
    //any refugee situation in the world, is also of the authorship of Joseph
    //Carens.

    function Me(nationality, scaryOther){
      this.nationality = nationality;
      this.scaryOther = scaryOther;
    }

    function Refugees(nationality, opressor, geographicalObstacle, promisedLand){
      this.nationality = nationality;
      this.opressor = opressor;
      this.geographicalObstacle = geographicalObstacle;
      this.promisedLand = promisedLand;
    }

    function RefugeeSituation(me, refugees){
      this.me = me;
      this.refugees = refugees;
    }

    let me1 = new Me("german", "extremists");
    let refugees1 = new Refugees("foreigner", "discrimination and persecution by their opressors", "deserts, lands and sea", "Germany");
    let refugeeSituation1 = new RefugeeSituation(me1, refugees1);

    let me2 = new Me("american", "criminals");
    let refugees2 = new Refugees("other", "poverty and lack of opportunities in their birth country", "border", "America");
    let refugeeSituation2 = new RefugeeSituation(me2, refugees2);

    let me3 = new Me("finnish", "simply very different from us");
    let refugees3 = new Refugees("people in other countries", "civil war in their birth country", "enormous number of countries, rivers, seas and even continents between there and our northern lands", "Finland");
    let refugeeSituation3 = new RefugeeSituation(me3, refugees3);

    let me4 = new Me("portuguese", "bad people");
    let refugees4 = new Refugees("foreign people", "terrible situations they face in their birth country", "national border by airplane", "Portugal");
    let refugeeSituation4 = new RefugeeSituation(me4, refugees4);

    //this is created to playback initially for a multitude of voices:
    let meGeneric = new Me("person", "(by external appearances) so different from me. That makes me scared. I am sure many of them shouldnt be trusted");
    let refugeesGeneric = new Refugees("other", "difficulties that they feel can only be solved by migrating", "all the obstacles, physical as well as immaterial, between their origin and our country.", "our country");
    let refugeeSituationGeneric = new RefugeeSituation(meGeneric, refugeesGeneric);

    function pulse(){
      $(this).animate({opacity:0},1000,function(){
        $(this).animate({opacity:1},1000,pulse)
      })
    }

    function stop(){
      $(this).stop(false,false).css({opacity:1})
    }

    //attributes methods pulse() and stop() to all elements in class "pulse"
    $(function(){
      $('.pulse').each(
        function(){
          var that=this;
          setTimeout(
            function() {pulse.call(that)},
            Math.random()*1000);
          }
        )
      })

    function startRecogniser(){
      if (synth.speaking) {
        $("#startRecogniser").html("Still speaking..");
        setTimeout(function () { $("#startRecogniser").html("Start recogniser"); }, 1000);
      } else {
        recognition.start();
        $("#recognitionP").text(" ... listening ");
        pulse.call($("#recognitionP"));
      }
    }

    function activate(){
      var btn = document.getElementById("activationButton");
      btn.remove();

      giveInformation().then(value => {
        $("#startRecogniser").css("visibility", "visible");
        voices = synth.getVoices();
        console.log(voices);
        displayRefugeeSituationSentences();
        showRandomLanguages();
        displayInstructions();
        $("#recognitionP").text(" ... listening");
        recognition.start();

      });

    }//close activate()

    var refugeeSituationDiv = document.getElementById("refugeeSituationDiv");

    function displayInstructions(){
      let instruction1 = "Say any of these:";
      $("#instructionsDiv").html("<p>" + instruction1 + "</p>");

    }//close displayInstructions

    function showRandomLanguages() {
      $("#refugeeSituationDiv").empty();

      var numberOfLanguages = 6;
      var languagesArrayCopy = languagesArray;
      var randomIndex;
      var chosenOne;
      var shorterLanguagesArray = [];

      for ( var i = 0 ; i < numberOfLanguages ; i ++){
        randomIndex = Math.floor(Math.random() * languagesArrayCopy.length );
        chosenOne = languagesArrayCopy[ randomIndex ];
        shorterLanguagesArray[i] = chosenOne;
        languagesArrayCopy.splice(randomIndex, 1);
        $("#refugeeSituationDiv").append(shorterLanguagesArray[i]);
      }//close for

    }//close showRandomLanguages

    //function createLanguagesArray() {
    function displayRefugeeSituationSentences(){

      //step 1) populate the list of possible languages.
      //do this only once!
      //step 2) every time that one reason is given, display a new set of six
      //languages.

      //does not work to toggle between visible and invisible....
      //must instead simply generate the list again each time....
      //OR: generate the list once, and then choose what to display...

      //once this goes to zero, we don't show any more languages:
      //maxChoices = 6;
      //display all possible voices:
      //todo: display only 4 selected voices
      //my bcp-47 list might be limited?

//*********************************************************************************

      //ALSO!!!! I need to get this to identify the different voices:
      //ie. there might be several different entries for ru-RU, and I need to
      //be able to show all of them, or do I?
      //OR: IF there are three different ru-RU voices, only choose one of them
      //for the array, because it looks silly when there are two lines that say
      //"___ I am Russian"

      for(var i=0 ; i < voices.length ; i++){
        for(var j = 0 ; j < languages.length ; j++){
          // && maxChoices > 0
          if( languages[j].bcp === voices[i].lang ){
            //Here, we are creating several instances of the same language:
            //because some languages have several voices.. eg. male, female
            //for the same language/bcp...
            //for each voice detected, we make an entry in the []:
            languagesArray[i] = "<p id=" + voices[i].name + " class=" + voices[i].lang + ">__ I am from " + languages[j].country + "</p>";
            //$("#refugeeSituationDiv").append("<p id=" + voices[i].name + " class=" + voices[i].lang + ">__ I am from " + languages[j].country + "</p>");
            //maxChoices--;
          }
        }
      }
      //console.log(refugeeSituationsArray);


      //how to make it so it chooses randomly which ones to display?

      //now we have appended them all to the refugeeSituationDiv, now let's hide
      //some of them:

      //how to: choose

      //for ( var i = 0; i < maxChoices ; i ++){
        //Math.floor(Math.random()

        //maxChoices--;
      //}

      //to jQuery
      refugeeSituationDiv.style.borderLeft = "2px dotted black";

    }//close displayRefugeeSituationSentences

    //example code: setTimeout implemented using a promise:
    //const wait = ms => new Promise(resolve => setTimeout(resolve, ms));
    //wait(10*1000).then(() => saySomething("10 seconds")).catch(failureCallback);

    var synth = window.speechSynthesis;
    var speakThis = new SpeechSynthesisUtterance;
    speakThis.text = '';

    window.SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;

    var recognition = new SpeechRecognition;
    recognition.lang = 'en-US';
    //recognition.continuous = true;

    recognition.interimResults = true;

    var transcript = '';
    var final_transcript = '';

    recognition.onspeechend = function() {
      //$("#recognitionP").text(" ... ");
      console.log("speech ended");
    }

    recognition.onsoundend = function() {
      console.log("Sound ended");
    }

    recognition.onsoundstart = function(){
      //solution?: if sound detected BUT then no speech detected:

    }

    //***************************************************************************
    //***************************************************************************

    //this works:
    //speaking I am American etc -> goes into synth speaking
    //error: no-speech -> reverts to blinking ...
    //random words -> eventually reverts to blinking ...
    //this does not work:
    //some sound detected -> continues blinking listening ...
    recognition.onend = function () {
      console.log("At recognition.onend, this is the result: ");
      console.log(event.results);
      if( latestSpeechEvent == undefined ){
        $("#recognitionP").text(" ... ");
      }
    }

    recognition.onresult = (event) => {

      console.log(event);
      stop.call($("#recognitionP"));

      var speechToText = event.results[0][0].transcript;

      $("#recognitionP").text(speechToText);
      $("#recognitionP").css("color", "gray");

      for(var i = 0 ; i < languages.length ; i++){

        if(speechToText.includes(languages[i].country)){

          var allInstancesOfThisLanguage = document.getElementById("refugeeSituationDiv").getElementsByClassName(languages[i].bcp);

          for ( let j = 0 ; j < allInstancesOfThisLanguage.length ; j ++){
            var boxChecked = allInstancesOfThisLanguage[j].textContent.replace("__", "_X_");
            allInstancesOfThisLanguage[j].textContent = boxChecked;
          }

          oppositionVoiced(refugeeSituationGeneric, languages[i].bcp);

        }
      }//close for

      if (!synth.speaking && event.results[0].isFinal){
        setTimeout(function() {
          $("#recognitionP").text(" ...");
          pulse.call($("#recognitionP"));
        }, 5000);

      } //end if synth is not speaking and result was final

      if (event.results[0].isFinal && speechToText.includes("what is this")) {
        giveInformation()
        .then(value => {
          //recognition.start();
          $("#recognitionP").text("...");
          pulse.call($("#recognitionP"));
        });
      };

    }//end recognition.onevent

    recognition.onerror = function(event) {
      //no-speech,
      console.log(event.error);
      $("#recognitionP").text("...");

    };

    function giveInformation() {
      return new Promise( function( resolve, reject ) {
        recognition.stop();
        $("#synthSpeakingDiv").text(">> " + information);
        speakThis.text = information;
        synth.speak(speakThis);

        speakThis.onend = function(event) {
          while (synthSpeakingDiv.hasChildNodes()) {
            synthSpeakingDiv.removeChild(synthSpeakingDiv.firstChild);
          }//end of while
          resolve();
        }//end of speakThis.onend
      });//end of new Promise
    }//end of giveInformation()

    function oppositionVoiced(refugeeSituation, language){
      recognition.stop();

      var myFullandHonestOpinion = replaceCarensGeneralisationWith(refugeeSituation);
      var myBriefOpinion = chooseSomeSentencesFrom(myFullandHonestOpinion);
      speakMyOpinion(language, myBriefOpinion);
      //speakMyOpinion( language, chooseSomeSentencesFrom(replaceCarensGeneralisationWith(refugeeSituation)));

      function replaceCarensGeneralisationWith(refugeeSituation){
        var myOpinion = [];
        for (var i = 0; i < carensGeneralisation.length; i++) {
          myOpinion[i] = carensGeneralisation[i].replace("Jewish refugees", "them");
          myOpinion[i] = myOpinion[i].replace(/Jew/g, refugeeSituation.refugees.nationality);
          myOpinion[i] = myOpinion[i].replace("North America", refugeeSituation.refugees.promisedLand);
          myOpinion[i] = myOpinion[i].replace("Atlantic", refugeeSituation.refugees.geographicalObstacle);
          myOpinion[i] = myOpinion[i].replace("communists", refugeeSituation.me.scaryOther);
          myOpinion[i] = myOpinion[i].replace(/Nazi phenomenon/g, refugeeSituation.refugees.opressor);
        }//end of for
        return myOpinion;
      }//end of replaceCarensGeneralisationWith()

      function chooseSomeSentencesFrom(myFullandHonestOpinion){
        var someSentences = [];
        someSentences[0] = myFullandHonestOpinion[0];
        //returns a random integer between 1 and length of array - 1
        var randomIndex = Math.floor(Math.random() * (myFullandHonestOpinion.length-1)) + 1;
        //console.log("randomIndex is:" + randomIndex);
        someSentences[1] = myFullandHonestOpinion[randomIndex];
        //console.log(someSentences);
        return someSentences;
      }//end of chooseSomeSentencesFrom()

      function speakMyOpinion(language, opinion){
        speakThis.lang = language;

        speakOneSentence(opinion[0])
        .then(value => speakOneSentence(opinion[1]))
        .then(value => {
          $("#recognitionP").text(" ... ");
          console.log("Spoke sentence, pulsing again:");
          pulse.call($("#recognitionP"));
          showRandomLanguages();
          /*for ( i = 1 ; i<refugeeSituationDiv.childNodes.length ; i++){
            var boxUnChecked = refugeeSituationDiv.childNodes[i].textContent.replace("_X_","__");
            refugeeSituationDiv.childNodes[i].textContent = boxUnChecked;
          }*/
          //recognition.start()
        });

        function speakOneSentence(sentence){
          return new Promise(function(resolve, reject){
            speakThis.text = sentence;
            synth.speak(speakThis);
            $("#synthSpeakingDiv").text(">> " + sentence);

            speakThis.onend = function(event) {
              $("#synthSpeakingDiv").text("");
              resolve();
            };

          });//end of return new Promise

        }//end of speakOneSentence

      }//end of speakMyOpinion()

    }//end of oppositionVoiced

  </script>
</body>
</html>
